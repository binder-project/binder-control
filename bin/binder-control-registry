#!/usr/bin/env node
var program = require('commander')
var shell = require('shelljs')
var path = require('path')

var util = require('../lib/util.js')

program
  .version('0.0.1')

program
  .command('start')
  .description('Start the registry server')
  .action(function () {
    console.log('Starting the registry server...')
    util.startWithPM2({
      name: 'binder-registry',
      script: path.join(__dirname, 'apps', 'registry.js'),
      args: process.argv.slice(2)
    }, function (err) {
      if (err) {
        console.error(err)
        process.exit(1)
      }
    })
  })
  .on('--help', function () {
    shell.exec('pm2 flush')
    util.startWithPM2({
      name: 'binder-registry',
      script: path.join(__dirname, 'apps', 'registry.js'),
      args: ['--help']
    }, function (err) {
      if (err) {
        console.error(err)
        process.exit(1)
      }
    })
    var help = shell.exec('pm2 logs binder-registry --lines=500', { async: true })
    help.kill()
  })

program
  .command('stop')
  .description('Stop the registry server')
  .action(function () {
    console.log('Stopping the registry server...')
    shell.exec('pm2 stop binder-registry')
  })

program.parse(process.argv)
